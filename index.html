<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í˜„ì¥ë³„ ê³„ì•½ í˜„í™© ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=1329b082580a4823b7f61332c8e24741&libraries=services&autoload=false"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Malgun Gothic', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f5f5f5;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-box h2 {
            margin-bottom: 8px;
            color: #333;
            font-size: 1.5em;
        }

        .login-box p {
            color: #666;
            margin-bottom: 24px;
            font-size: 0.9em;
        }

        .login-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            margin-bottom: 16px;
            transition: border-color 0.2s;
        }

        .login-input:focus {
            outline: none;
            border-color: #1976d2;
        }

        .login-input.error {
            border-color: #d32f2f;
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .login-btn:hover {
            background: #1565c0;
        }

        .login-error {
            color: #d32f2f;
            font-size: 0.85em;
            margin-top: 12px;
            display: none;
        }

        .hidden {
            display: none !important;
        }

        /* ì§€ë„ ì˜ì—­ */
        .map-container {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 16px;
            border: 1px solid #e0e0e0;
        }

        .map-legend {
            display: flex;
            gap: 16px;
            padding: 8px 16px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 0.85em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-marker.completed { background: #2e7d32; }
        .legend-marker.progress { background: #ed6c02; }
        .legend-marker.rejected { background: #d32f2f; }
        .legend-marker.unknown { background: #9e9e9e; }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 24px;
            font-size: 1.8em;
            font-weight: 600;
        }

        /* ìš”ì•½ ì¹´ë“œ */
        .summary-section {
            background: white;
            border-radius: 8px;
            padding: 20px 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .summary-row {
            display: flex;
            align-items: center;
            gap: 40px;
            flex-wrap: wrap;
        }

        .summary-item {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .summary-label {
            color: #666;
            font-size: 0.9em;
        }

        .summary-value {
            font-size: 1.5em;
            font-weight: 700;
        }

        .summary-value.completed { color: #2e7d32; }
        .summary-value.progress { color: #ed6c02; }
        .summary-value.rejected { color: #d32f2f; }

        .progress-container {
            flex: 1;
            min-width: 200px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-bar {
            flex: 1;
            height: 20px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill-completed {
            height: 100%;
            background: #4caf50;
            float: left;
            transition: width 0.3s ease;
        }

        .progress-fill-rejected {
            height: 100%;
            background: #d32f2f;
            float: left;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-weight: 700;
            font-size: 1.1em;
            min-width: 50px;
        }

        /* ë²„íŠ¼ ì˜ì—­ */
        .action-bar {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 16px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565c0;
        }

        .btn-secondary {
            background: #43a047;
            color: white;
        }

        .btn-secondary:hover {
            background: #388e3c;
        }

        /* í…Œì´ë¸” ë¦¬ìŠ¤íŠ¸ */
        .list-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .list-table {
            width: 100%;
            border-collapse: collapse;
        }

        .list-table th {
            background: #f8f9fa;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        .list-table td {
            padding: 10px 16px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .list-table tbody tr {
            cursor: pointer;
            transition: background 0.15s;
        }

        .list-table tbody tr:hover {
            background: #f8f9fa;
        }

        .site-name-cell {
            font-weight: 500;
            color: #1976d2;
        }

        .num-cell {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .num-cell.completed { color: #2e7d32; font-weight: 600; }
        .num-cell.progress { color: #ed6c02; font-weight: 600; }
        .num-cell.rejected { color: #d32f2f; font-weight: 600; }

        .progress-cell {
            width: 180px;
        }

        .mini-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mini-progress-bar {
            flex: 1;
            height: 16px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .mini-progress-fill-completed {
            height: 100%;
            background: #4caf50;
            float: left;
        }

        .mini-progress-fill-rejected {
            height: 100%;
            background: #d32f2f;
            float: left;
        }

        .mini-progress-text {
            min-width: 45px;
            text-align: right;
            font-weight: 600;
            font-size: 0.9em;
        }

        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            max-width: 1400px;
            width: 95%;
            margin: 30px auto;
            border-radius: 8px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
        }

        .close-btn {
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
            padding: 0 8px;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-summary {
            display: flex;
            gap: 32px;
            padding: 16px 24px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            flex-wrap: wrap;
        }

        .modal-stat {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .modal-stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .modal-stat-value {
            font-size: 1.3em;
            font-weight: 700;
        }

        .modal-body {
            padding: 0;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
        }

        .detail-table th {
            background: #f8f9fa;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        .detail-table td {
            padding: 10px 16px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }

        .detail-table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
            white-space: nowrap;
        }

        .status-completed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-progress {
            background: #fff3e0;
            color: #ed6c02;
        }

        .status-rejected {
            background: #ffebee;
            color: #d32f2f;
        }

        .loading {
            text-align: center;
            color: #666;
            font-size: 1.2em;
            padding: 60px;
        }

        /* ìˆœë²ˆ ì»¬ëŸ¼ */
        .seq-cell {
            color: #999;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-box">
            <h2>ğŸ”’ ì ‘ê·¼ ì¸ì¦</h2>
            <p>ê³„ì•½ í˜„í™© ëŒ€ì‹œë³´ë“œì— ì ‘ê·¼í•˜ë ¤ë©´<br>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="password" id="password-input" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="handleKeyPress(event)">
            <button class="login-btn" onclick="checkPassword()">ë¡œê·¸ì¸</button>
            <div id="login-error" class="login-error">ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
        </div>
    </div>

    <div id="main-content" class="hidden">
    <div class="container">
        <h1>DLì´ì•¤ì”¨ í˜„ì¥ë³„ ê³„ì•½ í˜„í™© ëŒ€ì‹œë³´ë“œ</h1>
        
        <div id="loading" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        
        <div id="dashboard" style="display: none;">
            <!-- ìš”ì•½ -->
            <div class="summary-section">
                <div class="summary-row">
                    <div class="summary-item">
                        <span class="summary-label">ì „ì²´ ë§¤ì¥</span>
                        <span class="summary-value" id="total-stores">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ê³„ì•½ ì™„ë£Œ</span>
                        <span class="summary-value completed" id="completed-count">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ì§„í–‰ ì¤‘</span>
                        <span class="summary-value progress" id="progress-count">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ê³„ì•½ ê±°ì ˆ</span>
                        <span class="summary-value rejected" id="rejected-count">0</span>
                    </div>
                    <div class="progress-container">
                        <span class="summary-label">ì§„ì²™ìœ¨</span>
                        <div class="progress-bar">
                            <div class="progress-fill-completed" id="progress-fill-completed"></div>
                            <div class="progress-fill-rejected" id="progress-fill-rejected"></div>
                        </div>
                        <span class="progress-text" id="completion-rate">0%</span>
                    </div>
                </div>
            </div>

            <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
            <div class="action-bar">
                <button class="btn btn-primary" onclick="downloadFullCSV()">
                    ğŸ“¥ ì „ì²´ CSV ë‹¤ìš´ë¡œë“œ
                </button>
                <button class="btn btn-secondary" onclick="downloadSummaryExcel()">
                    ğŸ“Š êµ¬ë¶„ë³„ í˜„í™© Excel
                </button>
            </div>

            <!-- ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” -->
            <div class="list-section">
                <table class="list-table">
                    <thead>
                        <tr>
                            <th style="width:50px">#</th>
                            <th style="width:140px">í˜„ì¥êµ¬ë¶„</th>
                            <th>í˜„ì¥</th>
                            <th style="width:80px">ì „ì²´</th>
                            <th style="width:80px">ì™„ë£Œ</th>
                            <th style="width:80px">ì§„í–‰ì¤‘</th>
                            <th style="width:80px">ê±°ì ˆ</th>
                            <th class="progress-cell">ì§„ì²™ìœ¨</th>
                        </tr>
                    </thead>
                    <tbody id="list-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ìƒì„¸ ëª¨ë‹¬ -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title"></h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-summary">
                <div class="modal-stat">
                    <span class="modal-stat-label">ì „ì²´</span>
                    <span class="modal-stat-value" id="modal-total">0</span>
                </div>
                <div class="modal-stat">
                    <span class="modal-stat-label">ì™„ë£Œ</span>
                    <span class="modal-stat-value" style="color:#2e7d32" id="modal-completed">0</span>
                </div>
                <div class="modal-stat">
                    <span class="modal-stat-label">ì§„í–‰ì¤‘</span>
                    <span class="modal-stat-value" style="color:#ed6c02" id="modal-progress">0</span>
                </div>
                <div class="modal-stat">
                    <span class="modal-stat-label">ê±°ì ˆ</span>
                    <span class="modal-stat-value" style="color:#d32f2f" id="modal-rejected">0</span>
                </div>
                <div class="modal-stat">
                    <span class="modal-stat-label">ì§„ì²™ìœ¨</span>
                    <span class="modal-stat-value" id="modal-rate">0%</span>
                </div>
                <div class="modal-progress-container">
                    <div class="mini-progress-bar" id="modal-progress-bar" style="width:200px;height:20px;"></div>
                </div>
            </div>
            <div class="modal-body">
                <!-- ì§€ë„ ì˜ì—­ -->
                <div style="padding: 16px 16px 0 16px;">
                    <div class="map-legend">
                        <div class="legend-item">
                            <div class="legend-marker completed"></div>
                            <span>ê³„ì•½ì™„ë£Œ</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker progress"></div>
                            <span>ì§„í–‰ì¤‘</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker rejected"></div>
                            <span>ê³„ì•½ê±°ì ˆ</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker unknown"></div>
                            <span>ë¯¸ì •</span>
                        </div>
                    </div>
                    <div id="map" class="map-container"></div>
                </div>
                
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th style="width:50px">ìˆœë²ˆ</th>
                            <th style="min-width:200px">ë§¤ì¥ëª…</th>
                            <th style="min-width:300px">ì£¼ì†Œ</th>
                            <th style="width:100px">ìƒíƒœ</th>
                            <th style="min-width:150px">ë¹„ê³ </th>
                        </tr>
                    </thead>
                    <tbody id="detail-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
    </div>

    <script>
        // ë¹„ë°€ë²ˆí˜¸ ì²´í¬
        function checkPassword() {
            const input = document.getElementById('password-input');
            const pwd = input.value;
            
            if (pwd === 'qpseltm123!') {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                sessionStorage.setItem('dashboard_auth', 'true');
                loadData();
            } else {
                input.classList.add('error');
                document.getElementById('login-error').style.display = 'block';
                setTimeout(() => {
                    input.classList.remove('error');
                }, 300);
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        }

        // ì„¸ì…˜ ì²´í¬ - ì´ë¯¸ ì¸ì¦ëœ ê²½ìš° ë°”ë¡œ ì§„ì…
        window.onload = function() {
            if (sessionStorage.getItem('dashboard_auth') === 'true') {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                loadData();
            }
        };

        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSzD8fDno66QoWMhKWJj4jTCsoCtiMPOe8SL11BC-1sIgSbEC-a3HFHY8JIUaTSjPEtkP3wHurWv7sh/pub?gid=1210603345&single=true&output=csv';

        let rawData = [];
        let siteData = {};

        // CSV íŒŒì‹± - ì—”í„°(ì¤„ë°”ê¿ˆ) í¬í•¨ëœ ì…€ ì²˜ë¦¬
        function parseCSV(text) {
            const result = [];
            const lines = [];
            let currentLine = '';
            let insideQuotes = false;
            
            // ì¤„ë°”ê¿ˆì´ í¬í•¨ëœ ì…€ ì²˜ë¦¬
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                
                if (char === '"') {
                    insideQuotes = !insideQuotes;
                    currentLine += char;
                } else if ((char === '\n' || char === '\r') && !insideQuotes) {
                    if (currentLine.trim()) {
                        lines.push(currentLine);
                    }
                    currentLine = '';
                    // \r\n ì²˜ë¦¬
                    if (char === '\r' && text[i + 1] === '\n') {
                        i++;
                    }
                } else {
                    currentLine += char;
                }
            }
            if (currentLine.trim()) {
                lines.push(currentLine);
            }

            // ê° ì¤„ íŒŒì‹±
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                
                if (values[0] && values[1]) {
                    result.push({
                        site: cleanText(values[0]),
                        store: cleanText(values[1]),
                        address: cleanText(values[2] || ''),
                        status: cleanText(values[4] || ''),
                        note: cleanText(values[5] || ''),
                        category: cleanText(values[6] || '')
                    });
                }
            }
            
            return result;
        }

        // CSV í•œ ì¤„ íŒŒì‹± - ì‰¼í‘œì™€ ë”°ì˜´í‘œ ì²˜ë¦¬
        function parseCSVLine(line) {
            const values = [];
            let currentValue = '';
            let insideQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (insideQuotes && line[i + 1] === '"') {
                        currentValue += '"';
                        i++;
                    } else {
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    values.push(currentValue);
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }
            values.push(currentValue);
            
            return values;
        }

        // í…ìŠ¤íŠ¸ ì •ë¦¬ - ì—”í„°, ì•ë’¤ ê³µë°± ì œê±°
        function cleanText(text) {
            return text
                .replace(/[\r\n]+/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function processData() {
            siteData = {};
            
            rawData.forEach(row => {
                if (!siteData[row.site]) {
                    siteData[row.site] = {
                        total: 0,
                        completed: 0,
                        progress: 0,
                        rejected: 0,
                        stores: [],
                        category: row.category || ''
                    };
                }
                
                siteData[row.site].total++;
                siteData[row.site].stores.push(row);
                
                const status = row.status.toLowerCase();
                if (status.includes('ì™„ë£Œ')) {
                    siteData[row.site].completed++;
                } else if (status.includes('ì§„í–‰') || status.includes('ëŒ€ê¸°')) {
                    siteData[row.site].progress++;
                } else if (status.includes('ê±°ì ˆ')) {
                    siteData[row.site].rejected++;
                }
            });
        }

        // ì§„ì²™ìœ¨ ê³„ì‚° - ì™„ë£Œ + ê±°ì ˆ í¬í•¨
        function calcRate(completed, rejected, total) {
            if (total === 0) return 0;
            return Math.round(((completed + rejected) / total) * 100);
        }

        function updateSummary() {
            const totalStores = rawData.length;
            let totalCompleted = 0;
            let totalProgress = 0;
            let totalRejected = 0;

            Object.values(siteData).forEach(site => {
                totalCompleted += site.completed;
                totalProgress += site.progress;
                totalRejected += site.rejected;
            });

            const rate = calcRate(totalCompleted, totalRejected, totalStores);
            const completedPct = totalStores > 0 ? (totalCompleted / totalStores) * 100 : 0;
            const rejectedPct = totalStores > 0 ? (totalRejected / totalStores) * 100 : 0;

            document.getElementById('total-stores').textContent = totalStores.toLocaleString();
            document.getElementById('completed-count').textContent = totalCompleted.toLocaleString();
            document.getElementById('progress-count').textContent = totalProgress.toLocaleString();
            document.getElementById('rejected-count').textContent = totalRejected.toLocaleString();
            document.getElementById('completion-rate').textContent = rate + '%';
            document.getElementById('progress-fill-completed').style.width = completedPct + '%';
            document.getElementById('progress-fill-rejected').style.width = rejectedPct + '%';
        }

        function renderList() {
            const tbody = document.getElementById('list-tbody');
            tbody.innerHTML = '';

            // ì •ë ¬: í˜„ì¥êµ¬ë¶„ -> í˜„ì¥ëª…
            const sortedSites = Object.entries(siteData)
                .sort((a, b) => {
                    const catCompare = (a[1].category || '').localeCompare(b[1].category || '');
                    if (catCompare !== 0) return catCompare;
                    return a[0].localeCompare(b[0]);
                });

            sortedSites.forEach(([siteName, site], index) => {
                const rate = calcRate(site.completed, site.rejected, site.total);
                const completedPct = site.total > 0 ? (site.completed / site.total) * 100 : 0;
                const rejectedPct = site.total > 0 ? (site.rejected / site.total) * 100 : 0;
                
                const row = document.createElement('tr');
                row.onclick = () => showDetail(siteName, site);
                
                row.innerHTML = `
                    <td class="seq-cell">${index + 1}</td>
                    <td>${site.category}</td>
                    <td class="site-name-cell">${siteName}</td>
                    <td class="num-cell">${site.total}</td>
                    <td class="num-cell completed">${site.completed}</td>
                    <td class="num-cell progress">${site.progress}</td>
                    <td class="num-cell rejected">${site.rejected}</td>
                    <td class="progress-cell">
                        <div class="mini-progress">
                            <div class="mini-progress-bar">
                                <div class="mini-progress-fill-completed" style="width:${completedPct}%"></div>
                                <div class="mini-progress-fill-rejected" style="width:${rejectedPct}%"></div>
                            </div>
                            <span class="mini-progress-text">${rate}%</span>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function showDetail(siteName, site) {
            document.getElementById('modal-title').textContent = siteName;
            document.getElementById('modal-total').textContent = site.total;
            document.getElementById('modal-completed').textContent = site.completed;
            document.getElementById('modal-progress').textContent = site.progress;
            document.getElementById('modal-rejected').textContent = site.rejected;
            
            const rate = calcRate(site.completed, site.rejected, site.total);
            const completedPct = site.total > 0 ? (site.completed / site.total) * 100 : 0;
            const rejectedPct = site.total > 0 ? (site.rejected / site.total) * 100 : 0;
            document.getElementById('modal-rate').textContent = rate + '%';
            
            // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì—…ë°ì´íŠ¸
            document.getElementById('modal-progress-bar').innerHTML = `
                <div class="mini-progress-fill-completed" style="width:${completedPct}%"></div>
                <div class="mini-progress-fill-rejected" style="width:${rejectedPct}%"></div>
            `;

            const tbody = document.getElementById('detail-tbody');
            tbody.innerHTML = '';

            // ì •ë ¬: ì§„í–‰ì¤‘ -> ì™„ë£Œ -> ê±°ì ˆ
            const sortedStores = [...site.stores].sort((a, b) => {
                const getOrder = (status) => {
                    const s = status.toLowerCase();
                    if (s.includes('ì§„í–‰') || s.includes('ëŒ€ê¸°')) return 1;
                    if (s.includes('ì™„ë£Œ')) return 2;
                    if (s.includes('ê±°ì ˆ')) return 3;
                    return 0; // ë¯¸ì •
                };
                return getOrder(a.status) - getOrder(b.status);
            });

            sortedStores.forEach((store, idx) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="seq-cell">${idx + 1}</td>
                    <td>${store.store}</td>
                    <td>${store.address}</td>
                    <td>
                        <span class="status-badge ${getStatusClass(store.status)}">
                            ${store.status || 'ë¯¸ì •'}
                        </span>
                    </td>
                    <td>${store.note}</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // ì§€ë„ ì´ˆê¸°í™” (ëª¨ë‹¬ì´ í‘œì‹œëœ í›„ ì‹¤í–‰)
            setTimeout(() => {
                initMap(sortedStores);
            }, 100);
        }

        let map = null;
        let markers = [];
        let overlays = [];
        let kakaoLoaded = false;
        let currentInfoOverlay = null; // í˜„ì¬ ì—´ë¦° ì •ë³´ì°½

        function initMap(stores) {
            const mapContainer = document.getElementById('map');
            
            // ì¹´ì¹´ì˜¤ë§µ ë¡œë“œ í™•ì¸
            if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
                mapContainer.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;">ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (API í‚¤ ë˜ëŠ” ë„ë©”ì¸ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”)</div>';
                return;
            }
            
            const loadMap = () => {
                // ê¸°ì¡´ ë§ˆì»¤, ì˜¤ë²„ë ˆì´ ì œê±°
                markers.forEach(m => m.setMap(null));
                overlays.forEach(o => o.setMap(null));
                markers = [];
                overlays = [];
                if (currentInfoOverlay) {
                    currentInfoOverlay.setMap(null);
                    currentInfoOverlay = null;
                }
                
                // ì§€ë„ ìƒì„± (ì‹¬í”Œí•œ ìŠ¤ì¹´ì´ë·° ì—†ëŠ” ê¸°ë³¸ ì§€ë„)
                const mapOption = {
                    center: new kakao.maps.LatLng(37.5665, 126.9780),
                    level: 5,
                    disableDoubleClickZoom: false
                };
                
                map = new kakao.maps.Map(mapContainer, mapOption);
                
                // ì§€ë„ íƒ€ì… ì»¨íŠ¸ë¡¤ ì œê±°í•˜ê³  ì‹¬í”Œí•˜ê²Œ
                // ì¤Œ ì»¨íŠ¸ë¡¤ë§Œ ì¶”ê°€
                const zoomControl = new kakao.maps.ZoomControl();
                map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
                
                // ì£¼ì†Œ-ì¢Œí‘œ ë³€í™˜ ê°ì²´
                const geocoder = new kakao.maps.services.Geocoder();
                const bounds = new kakao.maps.LatLngBounds();
                let validCount = 0;
                
                stores.forEach((store, idx) => {
                    if (!store.address) return;
                    
                    geocoder.addressSearch(store.address, function(result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                            
                            // ìƒíƒœì— ë”°ë¥¸ ë§ˆì»¤ ìƒ‰ìƒ
                            const markerColor = getMarkerColor(store.status);
                            
                            // ì»¤ìŠ¤í…€ ë§ˆì»¤ ìƒì„±
                            const markerContent = document.createElement('div');
                            markerContent.innerHTML = `
                                <div style="
                                    width: 18px;
                                    height: 18px;
                                    background: ${markerColor};
                                    border: 2px solid white;
                                    border-radius: 50%;
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                    cursor: pointer;
                                    transition: transform 0.15s;
                                " onmouseover="this.style.transform='scale(1.3)'" onmouseout="this.style.transform='scale(1)'"></div>
                            `;
                            
                            const customOverlay = new kakao.maps.CustomOverlay({
                                position: coords,
                                content: markerContent,
                                yAnchor: 0.5,
                                xAnchor: 0.5
                            });
                            customOverlay.setMap(map);
                            overlays.push(customOverlay);
                            
                            // ì •ë³´ì°½ (í´ë¦­ ì‹œ í‘œì‹œ)
                            const infoContent = `
                                <div style="
                                    background: white;
                                    padding: 10px 14px;
                                    border-radius: 8px;
                                    font-size: 13px;
                                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                                    white-space: nowrap;
                                    border-left: 4px solid ${markerColor};
                                ">
                                    <div style="font-weight: 600; margin-bottom: 4px;">${store.store}</div>
                                    <div style="font-size: 11px; color: #666;">${store.status || 'ë¯¸ì •'}</div>
                                </div>
                            `;
                            
                            const infoOverlay = new kakao.maps.CustomOverlay({
                                position: coords,
                                content: infoContent,
                                yAnchor: 1.5,
                                xAnchor: 0.5
                            });
                            
                            // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                            markerContent.onclick = function() {
                                // ê¸°ì¡´ ì •ë³´ì°½ ë‹«ê¸°
                                if (currentInfoOverlay) {
                                    currentInfoOverlay.setMap(null);
                                }
                                // ìƒˆ ì •ë³´ì°½ ì—´ê¸°
                                if (currentInfoOverlay === infoOverlay) {
                                    currentInfoOverlay = null;
                                } else {
                                    infoOverlay.setMap(map);
                                    currentInfoOverlay = infoOverlay;
                                }
                            };
                            
                            bounds.extend(coords);
                            validCount++;
                            
                            // ëª¨ë“  ë§ˆì»¤ê°€ í‘œì‹œë˜ë©´ bounds ë§ì¶¤
                            if (validCount > 0) {
                                map.setBounds(bounds, 100, 50, 100, 50); // ìƒí•˜ì¢Œìš° íŒ¨ë”©
                            }
                        }
                    });
                });
                
                // ì§€ë„ í´ë¦­ ì‹œ ì •ë³´ì°½ ë‹«ê¸°
                kakao.maps.event.addListener(map, 'click', function() {
                    if (currentInfoOverlay) {
                        currentInfoOverlay.setMap(null);
                        currentInfoOverlay = null;
                    }
                });
            };

            // kakao.maps.loadë¡œ SDK ì´ˆê¸°í™”
            if (!kakaoLoaded) {
                kakao.maps.load(function() {
                    kakaoLoaded = true;
                    loadMap();
                });
            } else {
                loadMap();
            }
        }

        function getMarkerColor(status) {
            const s = (status || '').toLowerCase();
            if (s.includes('ì™„ë£Œ')) return '#2e7d32';
            if (s.includes('ê±°ì ˆ')) return '#d32f2f';
            if (s.includes('ì§„í–‰') || s.includes('ëŒ€ê¸°')) return '#ed6c02';
            return '#9e9e9e';
        }

        function getStatusClass(status) {
            const s = status.toLowerCase();
            if (s.includes('ì™„ë£Œ')) return 'status-completed';
            if (s.includes('ê±°ì ˆ')) return 'status-rejected';
            return 'status-progress';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.body.style.overflow = '';
        }

        window.onclick = function(e) {
            const modal = document.getElementById('modal');
            if (e.target === modal) {
                closeModal();
            }
        }

        // ì „ì²´ CSV ë‹¤ìš´ë¡œë“œ
        function downloadFullCSV() {
            let csv = 'í˜„ì¥êµ¬ë¶„,í˜„ì¥,ë§¤ì¥ëª…,ì£¼ì†Œ,ìƒíƒœ,ë¹„ê³ \n';
            
            // ì •ë ¬: í˜„ì¥êµ¬ë¶„ -> í˜„ì¥ëª… -> ìƒíƒœ(ì§„í–‰ì¤‘->ì™„ë£Œ->ê±°ì ˆ)
            const sortedData = [...rawData].sort((a, b) => {
                const site1 = siteData[a.site];
                const site2 = siteData[b.site];
                const catCompare = (site1?.category || '').localeCompare(site2?.category || '');
                if (catCompare !== 0) return catCompare;
                const siteCompare = a.site.localeCompare(b.site);
                if (siteCompare !== 0) return siteCompare;
                const getOrder = (status) => {
                    const s = status.toLowerCase();
                    if (s.includes('ì§„í–‰') || s.includes('ëŒ€ê¸°')) return 1;
                    if (s.includes('ì™„ë£Œ')) return 2;
                    if (s.includes('ê±°ì ˆ')) return 3;
                    return 0;
                };
                return getOrder(a.status) - getOrder(b.status);
            });
            
            sortedData.forEach(row => {
                const cat = siteData[row.site]?.category || '';
                csv += `"${cat}","${row.site}","${row.store}","${row.address}","${row.status}","${row.note}"\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ê³„ì•½í˜„í™©_ì „ì²´_${getDateStr()}.csv`;
            link.click();
        }

        // êµ¬ë¶„ë³„ Excel ë‹¤ìš´ë¡œë“œ (ì§„ì²™ìœ¨ ë°” í¬í•¨)
        function downloadSummaryExcel() {
            const wb = XLSX.utils.book_new();
            
            // ìš”ì•½ ì‹œíŠ¸ ë°ì´í„°
            const summaryData = [
                ['í˜„ì¥ë³„ ê³„ì•½ í˜„í™© ìš”ì•½', '', '', '', '', '', '', ''],
                [''],
                ['#', 'í˜„ì¥êµ¬ë¶„', 'í˜„ì¥ëª…', 'ì „ì²´', 'ì™„ë£Œ', 'ì§„í–‰ì¤‘', 'ê±°ì ˆ', 'ì§„ì²™ìœ¨']
            ];
            
            // ì •ë ¬: í˜„ì¥êµ¬ë¶„ -> í˜„ì¥ëª…
            const sortedSites = Object.entries(siteData)
                .sort((a, b) => {
                    const catCompare = (a[1].category || '').localeCompare(b[1].category || '');
                    if (catCompare !== 0) return catCompare;
                    return a[0].localeCompare(b[0]);
                });
            
            sortedSites.forEach(([siteName, site], index) => {
                const rate = calcRate(site.completed, site.rejected, site.total);
                summaryData.push([
                    index + 1,
                    site.category,
                    siteName,
                    site.total,
                    site.completed,
                    site.progress,
                    site.rejected,
                    rate / 100
                ]);
            });
            
            // í•©ê³„ í–‰
            let totals = { total: 0, completed: 0, progress: 0, rejected: 0 };
            Object.values(siteData).forEach(site => {
                totals.total += site.total;
                totals.completed += site.completed;
                totals.progress += site.progress;
                totals.rejected += site.rejected;
            });
            const totalRate = calcRate(totals.completed, totals.rejected, totals.total);
            summaryData.push(['', '', 'í•©ê³„', totals.total, totals.completed, totals.progress, totals.rejected, totalRate / 100]);
            
            const ws = XLSX.utils.aoa_to_sheet(summaryData);
            
            // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = [
                { wch: 5 },   // #
                { wch: 12 },  // í˜„ì¥êµ¬ë¶„
                { wch: 35 },  // í˜„ì¥ëª…
                { wch: 8 },   // ì „ì²´
                { wch: 8 },   // ì™„ë£Œ
                { wch: 8 },   // ì§„í–‰ì¤‘
                { wch: 8 },   // ê±°ì ˆ
                { wch: 12 }   // ì§„ì²™ìœ¨
            ];
            
            // ì§„ì²™ìœ¨ ì»¬ëŸ¼ í¼ì„¼íŠ¸ í˜•ì‹ + ë°ì´í„°ë°” ìŠ¤íƒ€ì¼
            for (let i = 3; i < summaryData.length; i++) {
                const cellRef = XLSX.utils.encode_cell({ r: i, c: 7 });
                if (ws[cellRef]) {
                    ws[cellRef].z = '0%';
                }
            }
            
            XLSX.utils.book_append_sheet(wb, ws, 'ìš”ì•½');
            
            // ê° í˜„ì¥ë³„ ì‹œíŠ¸
            sortedSites.forEach(([siteName, site]) => {
                const sheetData = [
                    [`${siteName} ìƒì„¸ í˜„í™©`],
                    [`ì „ì²´: ${site.total} | ì™„ë£Œ: ${site.completed} | ì§„í–‰ì¤‘: ${site.progress} | ê±°ì ˆ: ${site.rejected} | ì§„ì²™ìœ¨: ${calcRate(site.completed, site.rejected, site.total)}%`],
                    [''],
                    ['ìˆœë²ˆ', 'ë§¤ì¥ëª…', 'ì£¼ì†Œ', 'ìƒíƒœ', 'ë¹„ê³ ']
                ];
                
                site.stores.forEach((store, idx) => {
                    sheetData.push([
                        idx + 1,
                        store.store,
                        store.address,
                        store.status || 'ë¯¸ì •',
                        store.note
                    ]);
                });
                
                const siteWs = XLSX.utils.aoa_to_sheet(sheetData);
                siteWs['!cols'] = [
                    { wch: 6 },
                    { wch: 30 },
                    { wch: 50 },
                    { wch: 12 },
                    { wch: 20 }
                ];
                
                // ì‹œíŠ¸ëª… ê¸¸ì´ ì œí•œ (31ì) ë° íŠ¹ìˆ˜ë¬¸ì ì œê±°
                let sheetName = siteName.replace(/[\\\/\*\?\[\]:]/g, '_').substring(0, 31);
                XLSX.utils.book_append_sheet(wb, siteWs, sheetName);
            });
            
            XLSX.writeFile(wb, `ê³„ì•½í˜„í™©_êµ¬ë¶„ë³„_${getDateStr()}.xlsx`);
        }

        function getDateStr() {
            const now = new Date();
            return `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
        }

        async function loadData() {
            try {
                const response = await fetch(CSV_URL);
                const text = await response.text();
                
                rawData = parseCSV(text);
                processData();
                updateSummary();
                renderList();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
            } catch (error) {
                document.getElementById('loading').textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message;
            }
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
