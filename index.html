<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÌòÑÏû•Î≥Ñ Í≥ÑÏïΩ ÌòÑÌô© ÎåÄÏãúÎ≥¥Îìú</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Malgun Gothic', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 24px;
            font-size: 1.8em;
            font-weight: 600;
        }

        /* ÏöîÏïΩ Ïπ¥Îìú */
        .summary-section {
            background: white;
            border-radius: 8px;
            padding: 20px 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .summary-row {
            display: flex;
            align-items: center;
            gap: 40px;
            flex-wrap: wrap;
        }

        .summary-item {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .summary-label {
            color: #666;
            font-size: 0.9em;
        }

        .summary-value {
            font-size: 1.5em;
            font-weight: 700;
        }

        .summary-value.completed { color: #2e7d32; }
        .summary-value.progress { color: #ed6c02; }
        .summary-value.rejected { color: #d32f2f; }

        .progress-container {
            flex: 1;
            min-width: 200px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-bar {
            flex: 1;
            height: 20px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill-completed {
            height: 100%;
            background: #4caf50;
            float: left;
            transition: width 0.3s ease;
        }

        .progress-fill-rejected {
            height: 100%;
            background: #d32f2f;
            float: left;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-weight: 700;
            font-size: 1.1em;
            min-width: 50px;
        }

        /* Î≤ÑÌäº ÏòÅÏó≠ */
        .action-bar {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 16px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565c0;
        }

        .btn-secondary {
            background: #43a047;
            color: white;
        }

        .btn-secondary:hover {
            background: #388e3c;
        }

        /* ÌÖåÏù¥Î∏î Î¶¨Ïä§Ìä∏ */
        .list-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .list-table {
            width: 100%;
            border-collapse: collapse;
        }

        .list-table th {
            background: #f8f9fa;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        .list-table td {
            padding: 10px 16px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .list-table tbody tr {
            cursor: pointer;
            transition: background 0.15s;
        }

        .list-table tbody tr:hover {
            background: #f8f9fa;
        }

        .site-name-cell {
            font-weight: 500;
            color: #1976d2;
        }

        .num-cell {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .num-cell.completed { color: #2e7d32; font-weight: 600; }
        .num-cell.progress { color: #ed6c02; font-weight: 600; }
        .num-cell.rejected { color: #d32f2f; font-weight: 600; }

        .progress-cell {
            width: 180px;
        }

        .mini-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mini-progress-bar {
            flex: 1;
            height: 16px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .mini-progress-fill-completed {
            height: 100%;
            background: #4caf50;
            float: left;
        }

        .mini-progress-fill-rejected {
            height: 100%;
            background: #d32f2f;
            float: left;
        }

        .mini-progress-text {
            min-width: 45px;
            text-align: right;
            font-weight: 600;
            font-size: 0.9em;
        }

        /* Î™®Îã¨ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            max-width: 1400px;
            width: 95%;
            margin: 30px auto;
            border-radius: 8px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
        }

        .close-btn {
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
            padding: 0 8px;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-summary {
            display: flex;
            gap: 32px;
            padding: 16px 24px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            flex-wrap: wrap;
        }

        .modal-stat {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .modal-stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .modal-stat-value {
            font-size: 1.3em;
            font-weight: 700;
        }

        .modal-body {
            padding: 0;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
        }

        .detail-table th {
            background: #f8f9fa;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        .detail-table td {
            padding: 10px 16px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }

        .detail-table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
            white-space: nowrap;
        }

        .status-completed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-progress {
            background: #fff3e0;
            color: #ed6c02;
        }

        .status-rejected {
            background: #ffebee;
            color: #d32f2f;
        }

        .loading {
            text-align: center;
            color: #666;
            font-size: 1.2em;
            padding: 60px;
        }

        /* ÏàúÎ≤à Ïª¨Îüº */
        .seq-cell {
            color: #999;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>DLÏù¥Ïï§Ïî® ÌòÑÏû•Î≥Ñ Í≥ÑÏïΩ ÌòÑÌô© ÎåÄÏãúÎ≥¥Îìú</h1>
        
        <div id="loading" class="loading">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        
        <div id="dashboard" style="display: none;">
            <!-- ÏöîÏïΩ -->
            <div class="summary-section">
                <div class="summary-row">
                    <div class="summary-item">
                        <span class="summary-label">Ï†ÑÏ≤¥ Îß§Ïû•</span>
                        <span class="summary-value" id="total-stores">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Í≥ÑÏïΩ ÏôÑÎ£å</span>
                        <span class="summary-value completed" id="completed-count">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ÏßÑÌñâ Ï§ë</span>
                        <span class="summary-value progress" id="progress-count">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Í≥ÑÏïΩ Í±∞Ï†à</span>
                        <span class="summary-value rejected" id="rejected-count">0</span>
                    </div>
                    <div class="progress-container">
                        <span class="summary-label">ÏßÑÏ≤ôÏú®</span>
                        <div class="progress-bar">
                            <div class="progress-fill-completed" id="progress-fill-completed"></div>
                            <div class="progress-fill-rejected" id="progress-fill-rejected"></div>
                        </div>
                        <span class="progress-text" id="completion-rate">0%</span>
                    </div>
                </div>
            </div>

            <!-- Îã§Ïö¥Î°úÎìú Î≤ÑÌäº -->
            <div class="action-bar">
                <button class="btn btn-primary" onclick="downloadFullCSV()">
                    üì• Ï†ÑÏ≤¥ CSV Îã§Ïö¥Î°úÎìú
                </button>
                <button class="btn btn-secondary" onclick="downloadSummaryExcel()">
                    üìä Íµ¨Î∂ÑÎ≥Ñ ÌòÑÌô© Excel
                </button>
            </div>

            <!-- Î¶¨Ïä§Ìä∏ ÌÖåÏù¥Î∏î -->
            <div class="list-section">
                <table class="list-table">
                    <thead>
                        <tr>
                            <th style="width:50px">#</th>
                            <th style="width:100px">ÌòÑÏû•Íµ¨Î∂Ñ</th>
                            <th>ÌòÑÏû•</th>
                            <th style="width:80px">Ï†ÑÏ≤¥</th>
                            <th style="width:80px">ÏôÑÎ£å</th>
                            <th style="width:80px">ÏßÑÌñâÏ§ë</th>
                            <th style="width:80px">Í±∞Ï†à</th>
                            <th class="progress-cell">ÏßÑÏ≤ôÏú®</th>
                        </tr>
                    </thead>
                    <tbody id="list-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ÏÉÅÏÑ∏ Î™®Îã¨ -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title"></h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-summary">
                <div class="modal-stat">
                    <span class="modal-stat-label">Ï†ÑÏ≤¥</span>
                    <span class="modal-stat-value" id="modal-total">0</span>
                </div>
                <div class="modal-stat">
                    <span class="modal-stat-label">ÏôÑÎ£å</span>
                    <span class="modal-stat-value" style="color:#2e7d32" id="modal-completed">0</span>
                </div>
                <div class="modal-stat">
                    <span class="modal-stat-label">ÏßÑÌñâÏ§ë</span>
                    <span class="modal-stat-value" style="color:#ed6c02" id="modal-progress">0</span>
                </div>
                <div class="modal-stat">
                    <span class="modal-stat-label">Í±∞Ï†à</span>
                    <span class="modal-stat-value" style="color:#d32f2f" id="modal-rejected">0</span>
                </div>
                <div class="modal-stat">
                    <span class="modal-stat-label">ÏßÑÏ≤ôÏú®</span>
                    <span class="modal-stat-value" id="modal-rate">0%</span>
                </div>
                <div class="modal-progress-container">
                    <div class="mini-progress-bar" id="modal-progress-bar" style="width:200px;height:20px;"></div>
                </div>
            </div>
            <div class="modal-body">
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th style="width:50px">ÏàúÎ≤à</th>
                            <th style="min-width:200px">Îß§Ïû•Î™Ö</th>
                            <th style="min-width:300px">Ï£ºÏÜå</th>
                            <th style="width:100px">ÏÉÅÌÉú</th>
                            <th style="min-width:150px">ÎπÑÍ≥†</th>
                        </tr>
                    </thead>
                    <tbody id="detail-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSzD8fDno66QoWMhKWJj4jTCsoCtiMPOe8SL11BC-1sIgSbEC-a3HFHY8JIUaTSjPEtkP3wHurWv7sh/pub?gid=1210603345&single=true&output=csv';

        let rawData = [];
        let siteData = {};

        // CSV ÌååÏã± - ÏóîÌÑ∞(Ï§ÑÎ∞îÍøà) Ìè¨Ìï®Îêú ÏÖÄ Ï≤òÎ¶¨
        function parseCSV(text) {
            const result = [];
            const lines = [];
            let currentLine = '';
            let insideQuotes = false;
            
            // Ï§ÑÎ∞îÍøàÏù¥ Ìè¨Ìï®Îêú ÏÖÄ Ï≤òÎ¶¨
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                
                if (char === '"') {
                    insideQuotes = !insideQuotes;
                    currentLine += char;
                } else if ((char === '\n' || char === '\r') && !insideQuotes) {
                    if (currentLine.trim()) {
                        lines.push(currentLine);
                    }
                    currentLine = '';
                    // \r\n Ï≤òÎ¶¨
                    if (char === '\r' && text[i + 1] === '\n') {
                        i++;
                    }
                } else {
                    currentLine += char;
                }
            }
            if (currentLine.trim()) {
                lines.push(currentLine);
            }

            // Í∞Å Ï§Ñ ÌååÏã±
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                
                if (values[0] && values[1]) {
                    result.push({
                        site: cleanText(values[0]),
                        store: cleanText(values[1]),
                        address: cleanText(values[2] || ''),
                        status: cleanText(values[4] || ''),
                        note: cleanText(values[5] || ''),
                        category: cleanText(values[6] || '')
                    });
                }
            }
            
            return result;
        }

        // CSV Ìïú Ï§Ñ ÌååÏã± - ÏâºÌëúÏôÄ Îî∞Ïò¥Ìëú Ï≤òÎ¶¨
        function parseCSVLine(line) {
            const values = [];
            let currentValue = '';
            let insideQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (insideQuotes && line[i + 1] === '"') {
                        currentValue += '"';
                        i++;
                    } else {
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    values.push(currentValue);
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }
            values.push(currentValue);
            
            return values;
        }

        // ÌÖçÏä§Ìä∏ Ï†ïÎ¶¨ - ÏóîÌÑ∞, ÏïûÎí§ Í≥µÎ∞± Ï†úÍ±∞
        function cleanText(text) {
            return text
                .replace(/[\r\n]+/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function processData() {
            siteData = {};
            
            rawData.forEach(row => {
                if (!siteData[row.site]) {
                    siteData[row.site] = {
                        total: 0,
                        completed: 0,
                        progress: 0,
                        rejected: 0,
                        stores: [],
                        category: row.category || ''
                    };
                }
                
                siteData[row.site].total++;
                siteData[row.site].stores.push(row);
                
                const status = row.status.toLowerCase();
                if (status.includes('ÏôÑÎ£å')) {
                    siteData[row.site].completed++;
                } else if (status.includes('ÏßÑÌñâ') || status.includes('ÎåÄÍ∏∞')) {
                    siteData[row.site].progress++;
                } else if (status.includes('Í±∞Ï†à')) {
                    siteData[row.site].rejected++;
                }
            });
        }

        // ÏßÑÏ≤ôÏú® Í≥ÑÏÇ∞ - ÏôÑÎ£å + Í±∞Ï†à Ìè¨Ìï®
        function calcRate(completed, rejected, total) {
            if (total === 0) return 0;
            return Math.round(((completed + rejected) / total) * 100);
        }

        function updateSummary() {
            const totalStores = rawData.length;
            let totalCompleted = 0;
            let totalProgress = 0;
            let totalRejected = 0;

            Object.values(siteData).forEach(site => {
                totalCompleted += site.completed;
                totalProgress += site.progress;
                totalRejected += site.rejected;
            });

            const rate = calcRate(totalCompleted, totalRejected, totalStores);
            const completedPct = totalStores > 0 ? (totalCompleted / totalStores) * 100 : 0;
            const rejectedPct = totalStores > 0 ? (totalRejected / totalStores) * 100 : 0;

            document.getElementById('total-stores').textContent = totalStores.toLocaleString();
            document.getElementById('completed-count').textContent = totalCompleted.toLocaleString();
            document.getElementById('progress-count').textContent = totalProgress.toLocaleString();
            document.getElementById('rejected-count').textContent = totalRejected.toLocaleString();
            document.getElementById('completion-rate').textContent = rate + '%';
            document.getElementById('progress-fill-completed').style.width = completedPct + '%';
            document.getElementById('progress-fill-rejected').style.width = rejectedPct + '%';
        }

        function renderList() {
            const tbody = document.getElementById('list-tbody');
            tbody.innerHTML = '';

            // Ï†ïÎ†¨: ÌòÑÏû•Íµ¨Î∂Ñ -> ÌòÑÏû•Î™Ö
            const sortedSites = Object.entries(siteData)
                .sort((a, b) => {
                    const catCompare = (a[1].category || '').localeCompare(b[1].category || '');
                    if (catCompare !== 0) return catCompare;
                    return a[0].localeCompare(b[0]);
                });

            sortedSites.forEach(([siteName, site], index) => {
                const rate = calcRate(site.completed, site.rejected, site.total);
                const completedPct = site.total > 0 ? (site.completed / site.total) * 100 : 0;
                const rejectedPct = site.total > 0 ? (site.rejected / site.total) * 100 : 0;
                
                const row = document.createElement('tr');
                row.onclick = () => showDetail(siteName, site);
                
                row.innerHTML = `
                    <td class="seq-cell">${index + 1}</td>
                    <td>${site.category}</td>
                    <td class="site-name-cell">${siteName}</td>
                    <td class="num-cell">${site.total}</td>
                    <td class="num-cell completed">${site.completed}</td>
                    <td class="num-cell progress">${site.progress}</td>
                    <td class="num-cell rejected">${site.rejected}</td>
                    <td class="progress-cell">
                        <div class="mini-progress">
                            <div class="mini-progress-bar">
                                <div class="mini-progress-fill-completed" style="width:${completedPct}%"></div>
                                <div class="mini-progress-fill-rejected" style="width:${rejectedPct}%"></div>
                            </div>
                            <span class="mini-progress-text">${rate}%</span>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function showDetail(siteName, site) {
            document.getElementById('modal-title').textContent = siteName;
            document.getElementById('modal-total').textContent = site.total;
            document.getElementById('modal-completed').textContent = site.completed;
            document.getElementById('modal-progress').textContent = site.progress;
            document.getElementById('modal-rejected').textContent = site.rejected;
            
            const rate = calcRate(site.completed, site.rejected, site.total);
            const completedPct = site.total > 0 ? (site.completed / site.total) * 100 : 0;
            const rejectedPct = site.total > 0 ? (site.rejected / site.total) * 100 : 0;
            document.getElementById('modal-rate').textContent = rate + '%';
            
            // ÌîÑÎ°úÍ∑∏Î†àÏä§Î∞î ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('modal-progress-bar').innerHTML = `
                <div class="mini-progress-fill-completed" style="width:${completedPct}%"></div>
                <div class="mini-progress-fill-rejected" style="width:${rejectedPct}%"></div>
            `;

            const tbody = document.getElementById('detail-tbody');
            tbody.innerHTML = '';

            // Ï†ïÎ†¨: ÏßÑÌñâÏ§ë -> ÏôÑÎ£å -> Í±∞Ï†à
            const sortedStores = [...site.stores].sort((a, b) => {
                const getOrder = (status) => {
                    const s = status.toLowerCase();
                    if (s.includes('ÏßÑÌñâ') || s.includes('ÎåÄÍ∏∞')) return 1;
                    if (s.includes('ÏôÑÎ£å')) return 2;
                    if (s.includes('Í±∞Ï†à')) return 3;
                    return 0; // ÎØ∏Ï†ï
                };
                return getOrder(a.status) - getOrder(b.status);
            });

            sortedStores.forEach((store, idx) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="seq-cell">${idx + 1}</td>
                    <td>${store.store}</td>
                    <td>${store.address}</td>
                    <td>
                        <span class="status-badge ${getStatusClass(store.status)}">
                            ${store.status || 'ÎØ∏Ï†ï'}
                        </span>
                    </td>
                    <td>${store.note}</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function getStatusClass(status) {
            const s = status.toLowerCase();
            if (s.includes('ÏôÑÎ£å')) return 'status-completed';
            if (s.includes('Í±∞Ï†à')) return 'status-rejected';
            return 'status-progress';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.body.style.overflow = '';
        }

        window.onclick = function(e) {
            const modal = document.getElementById('modal');
            if (e.target === modal) {
                closeModal();
            }
        }

        // Ï†ÑÏ≤¥ CSV Îã§Ïö¥Î°úÎìú
        function downloadFullCSV() {
            let csv = 'ÌòÑÏû•Íµ¨Î∂Ñ,ÌòÑÏû•,Îß§Ïû•Î™Ö,Ï£ºÏÜå,ÏÉÅÌÉú,ÎπÑÍ≥†\n';
            
            // Ï†ïÎ†¨: ÌòÑÏû•Íµ¨Î∂Ñ -> ÌòÑÏû•Î™Ö -> ÏÉÅÌÉú(ÏßÑÌñâÏ§ë->ÏôÑÎ£å->Í±∞Ï†à)
            const sortedData = [...rawData].sort((a, b) => {
                const site1 = siteData[a.site];
                const site2 = siteData[b.site];
                const catCompare = (site1?.category || '').localeCompare(site2?.category || '');
                if (catCompare !== 0) return catCompare;
                const siteCompare = a.site.localeCompare(b.site);
                if (siteCompare !== 0) return siteCompare;
                const getOrder = (status) => {
                    const s = status.toLowerCase();
                    if (s.includes('ÏßÑÌñâ') || s.includes('ÎåÄÍ∏∞')) return 1;
                    if (s.includes('ÏôÑÎ£å')) return 2;
                    if (s.includes('Í±∞Ï†à')) return 3;
                    return 0;
                };
                return getOrder(a.status) - getOrder(b.status);
            });
            
            sortedData.forEach(row => {
                const cat = siteData[row.site]?.category || '';
                csv += `"${cat}","${row.site}","${row.store}","${row.address}","${row.status}","${row.note}"\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Í≥ÑÏïΩÌòÑÌô©_Ï†ÑÏ≤¥_${getDateStr()}.csv`;
            link.click();
        }

        // Íµ¨Î∂ÑÎ≥Ñ Excel Îã§Ïö¥Î°úÎìú (ÏßÑÏ≤ôÏú® Î∞î Ìè¨Ìï®)
        function downloadSummaryExcel() {
            const wb = XLSX.utils.book_new();
            
            // ÏöîÏïΩ ÏãúÌä∏ Îç∞Ïù¥ÌÑ∞
            const summaryData = [
                ['ÌòÑÏû•Î≥Ñ Í≥ÑÏïΩ ÌòÑÌô© ÏöîÏïΩ', '', '', '', '', '', '', ''],
                [''],
                ['#', 'ÌòÑÏû•Íµ¨Î∂Ñ', 'ÌòÑÏû•Î™Ö', 'Ï†ÑÏ≤¥', 'ÏôÑÎ£å', 'ÏßÑÌñâÏ§ë', 'Í±∞Ï†à', 'ÏßÑÏ≤ôÏú®']
            ];
            
            // Ï†ïÎ†¨: ÌòÑÏû•Íµ¨Î∂Ñ -> ÌòÑÏû•Î™Ö
            const sortedSites = Object.entries(siteData)
                .sort((a, b) => {
                    const catCompare = (a[1].category || '').localeCompare(b[1].category || '');
                    if (catCompare !== 0) return catCompare;
                    return a[0].localeCompare(b[0]);
                });
            
            sortedSites.forEach(([siteName, site], index) => {
                const rate = calcRate(site.completed, site.rejected, site.total);
                summaryData.push([
                    index + 1,
                    site.category,
                    siteName,
                    site.total,
                    site.completed,
                    site.progress,
                    site.rejected,
                    rate / 100
                ]);
            });
            
            // Ìï©Í≥Ñ Ìñâ
            let totals = { total: 0, completed: 0, progress: 0, rejected: 0 };
            Object.values(siteData).forEach(site => {
                totals.total += site.total;
                totals.completed += site.completed;
                totals.progress += site.progress;
                totals.rejected += site.rejected;
            });
            const totalRate = calcRate(totals.completed, totals.rejected, totals.total);
            summaryData.push(['', '', 'Ìï©Í≥Ñ', totals.total, totals.completed, totals.progress, totals.rejected, totalRate / 100]);
            
            const ws = XLSX.utils.aoa_to_sheet(summaryData);
            
            // Ïª¨Îüº ÎÑàÎπÑ ÏÑ§Ï†ï
            ws['!cols'] = [
                { wch: 5 },   // #
                { wch: 20 },  // ÌòÑÏû•Íµ¨Î∂Ñ
                { wch: 35 },  // ÌòÑÏû•Î™Ö
                { wch: 8 },   // Ï†ÑÏ≤¥
                { wch: 8 },   // ÏôÑÎ£å
                { wch: 8 },   // ÏßÑÌñâÏ§ë
                { wch: 8 },   // Í±∞Ï†à
                { wch: 12 }   // ÏßÑÏ≤ôÏú®
            ];
            
            // ÏßÑÏ≤ôÏú® Ïª¨Îüº ÌçºÏÑºÌä∏ ÌòïÏãù + Îç∞Ïù¥ÌÑ∞Î∞î Ïä§ÌÉÄÏùº
            for (let i = 3; i < summaryData.length; i++) {
                const cellRef = XLSX.utils.encode_cell({ r: i, c: 7 });
                if (ws[cellRef]) {
                    ws[cellRef].z = '0%';
                }
            }
            
            XLSX.utils.book_append_sheet(wb, ws, 'ÏöîÏïΩ');
            
            // Í∞Å ÌòÑÏû•Î≥Ñ ÏãúÌä∏
            sortedSites.forEach(([siteName, site]) => {
                const sheetData = [
                    [`${siteName} ÏÉÅÏÑ∏ ÌòÑÌô©`],
                    [`Ï†ÑÏ≤¥: ${site.total} | ÏôÑÎ£å: ${site.completed} | ÏßÑÌñâÏ§ë: ${site.progress} | Í±∞Ï†à: ${site.rejected} | ÏßÑÏ≤ôÏú®: ${calcRate(site.completed, site.rejected, site.total)}%`],
                    [''],
                    ['ÏàúÎ≤à', 'Îß§Ïû•Î™Ö', 'Ï£ºÏÜå', 'ÏÉÅÌÉú', 'ÎπÑÍ≥†']
                ];
                
                site.stores.forEach((store, idx) => {
                    sheetData.push([
                        idx + 1,
                        store.store,
                        store.address,
                        store.status || 'ÎØ∏Ï†ï',
                        store.note
                    ]);
                });
                
                const siteWs = XLSX.utils.aoa_to_sheet(sheetData);
                siteWs['!cols'] = [
                    { wch: 6 },
                    { wch: 30 },
                    { wch: 50 },
                    { wch: 12 },
                    { wch: 20 }
                ];
                
                // ÏãúÌä∏Î™Ö Í∏∏Ïù¥ Ï†úÌïú (31Ïûê) Î∞è ÌäπÏàòÎ¨∏Ïûê Ï†úÍ±∞
                let sheetName = siteName.replace(/[\\\/\*\?\[\]:]/g, '_').substring(0, 31);
                XLSX.utils.book_append_sheet(wb, siteWs, sheetName);
            });
            
            XLSX.writeFile(wb, `Í≥ÑÏïΩÌòÑÌô©_Íµ¨Î∂ÑÎ≥Ñ_${getDateStr()}.xlsx`);
        }

        function getDateStr() {
            const now = new Date();
            return `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
        }

        async function loadData() {
            try {
                const response = await fetch(CSV_URL);
                const text = await response.text();
                
                rawData = parseCSV(text);
                processData();
                updateSummary();
                renderList();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
            } catch (error) {
                document.getElementById('loading').textContent = 'Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message;
            }
        }

        // ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        loadData();
    </script>
</body>
</html>
